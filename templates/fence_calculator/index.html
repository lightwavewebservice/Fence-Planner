{% extends 'base.html' %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
  <div class="md:col-span-2 rounded-lg p-5 border border-slate-800/60 bg-slate-900/60 shadow-glow">
    <h2 class="text-lg font-semibold mb-4 text-slate-100">Calculator</h2>
    <form id="calc-form" class="space-y-3">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Netting</label>
        <select id="netting" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Number of wires</label>
        <input id="wire_count" type="number" min="1" max="20" step="1" value="2" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2" />
      </div>
      <input type="hidden" id="fence_type" />
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Fence length (m)</label>
        <input id="fence_length" type="number" step="0.01" min="0.01" max="50000" required class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2" placeholder="e.g. 500" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Distance between posts (m)</label>
        <input id="post_spacing" type="number" step="0.01" min="0.01" max="50" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2" placeholder="e.g. 8.0" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Top wire type</label>
        <select id="top_wire_type" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2">
          <option value="standard">Standard</option>
          <option value="hot">Hot</option>
          <option value="barb">Barb</option>
        </select>
      </div>
      <div id="hot_wire_count_container" class="hidden">
        <label class="block text-sm font-medium mb-1 text-slate-300">Number of hot wires</label>
        <select id="hot_wire_count" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
        </select>
        <span class="text-xs text-slate-400">How many wires should be hot (including the top wire)</span>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Labor rate (NZD/h, optional)</label>
        <input id="labor_rate" type="number" step="0.01" min="0" max="1000" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2" placeholder="{{ default_labor_rate }}" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-slate-300">Staples per box (optional)</label>
        <input id="staples_per_box" type="number" step="1" min="1" max="100000" class="w-full border border-slate-700 bg-slate-800/70 text-slate-200 rounded px-3 py-2" placeholder="2000" />
        <span class="text-xs text-slate-400">Default is 2,000 staples per box at $183.99</span>
      </div>
      <div class="pt-2">
        <button type="submit" class="bg-blue-600 text-white rounded px-4 py-2">Calculate</button>
        <span id="calc-status" class="ml-2 text-sm text-gray-500"></span>
      </div>
    </form>
    <div id="results" class="mt-6 hidden">
      <h3 class="text-md font-semibold mb-2 text-slate-100">Results</h3>
      <div class="space-y-1 text-sm text-slate-300" id="results-body"></div>
      <div class="mt-4 space-x-3">
        <a id="pdf-link" class="text-primary-400 hover:text-primary-300 underline-offset-2 hover:underline" target="_blank">Download PDF</a>
        <a id="xlsx-link" class="text-primary-400 hover:text-primary-300 underline-offset-2 hover:underline" target="_blank">Download Excel</a>
      </div>
    </div>
  </div>
  <div class="rounded-lg p-5 border border-slate-800/60 bg-slate-900/60 shadow-glow">
    <h2 class="text-lg font-semibold mb-4 text-slate-100">Recent calculations</h2>
    <ul class="space-y-2 text-sm text-slate-300">
      {% for c in recent_calcs %}
        <li class="flex items-center justify-between">
          <span>#{{ c.id }} — {{ c.fence_type }} ({{ c.fence_length }} m)</span>
          <a class="text-primary-400 hover:text-primary-300 underline-offset-2 hover:underline" href="/calculation/{{ c.id }}">View</a>
        </li>
      {% empty %}
        <li>No recent calculations.</li>
      {% endfor %}
    </ul>
  </div>
</div>
<script>
async function loadFenceTypes() {
  const res = await fetch('/api/fence-types');
  const data = await res.json();
  // Get the first active fence type as default (for material mapping)
  window.__ftMap = {};
  if (data.fence_types.length > 0) {
    const first = data.fence_types[0];
    document.getElementById('fence_type').value = first.id;
    window.__ftMap[String(first.id)] = first;
    document.getElementById('post_spacing').value = first.post_spacing;
  }
}

// Add event listener for netting changes
document.addEventListener('DOMContentLoaded', function() {
  const nettingSelect = document.getElementById('netting');
  const topWireTypeSelect = document.getElementById('top_wire_type');
  const hotWireCountContainer = document.getElementById('hot_wire_count_container');
  const hotWireCountSelect = document.getElementById('hot_wire_count');
  const wireCountInput = document.getElementById('wire_count');

  // Netting toggle adjusts total wire count
  nettingSelect.addEventListener('change', function() {
    // When netting is selected, adjust wire count to 1 (netting counts as 1 wire)
    // When netting is not selected, restore default wire count
    if (this.value === 'yes') {
      wireCountInput.value = 1;
    } else {
      wireCountInput.value = 2;
    }
    // Ensure hot wire count does not exceed total wires
    if (topWireTypeSelect.value === 'hot') {
      const total = parseInt(wireCountInput.value) || 1;
      if ((parseInt(hotWireCountSelect.value) || 1) > total) {
        hotWireCountSelect.value = String(total);
      }
    }
  });

  // Show/hide hot wire dropdown when 'Hot' selected
  topWireTypeSelect.addEventListener('change', function() {
    if (this.value === 'hot') {
      hotWireCountContainer.classList.remove('hidden');
      // Default to 1 if empty
      if (!hotWireCountSelect.value) hotWireCountSelect.value = '1';
      // Cap to total wires
      const total = parseInt(wireCountInput.value) || 1;
      if ((parseInt(hotWireCountSelect.value) || 1) > total) {
        hotWireCountSelect.value = String(total);
      }
    } else {
      hotWireCountContainer.classList.add('hidden');
    }
  });

  // Keep hot wire count <= total wires
  wireCountInput.addEventListener('change', function() {
    const total = parseInt(wireCountInput.value) || 1;
    if (topWireTypeSelect.value === 'hot') {
      if ((parseInt(hotWireCountSelect.value) || 1) > total) {
        hotWireCountSelect.value = String(total);
      }
    }
  });
});

// Client-side validation functions
function validateInput() {
  const errors = [];
  
  // Validate fence length
  const fenceLength = document.getElementById('fence_length').value;
  if (!fenceLength) {
    errors.push('Fence length is required');
  } else {
    const length = parseFloat(fenceLength);
    if (isNaN(length) || length <= 0) {
      errors.push('Fence length must be greater than 0');
    } else if (length > 50000) {
      errors.push('Fence length cannot exceed 50,000 meters');
    }
  }
  
  // Validate labor rate if provided
  const laborRate = document.getElementById('labor_rate').value;
  if (laborRate) {
    const rate = parseFloat(laborRate);
    if (isNaN(rate) || rate < 0) {
      errors.push('Labor rate cannot be negative');
    } else if (rate > 1000) {
      errors.push('Labor rate cannot exceed $1,000/hour');
    }
  }
  
  // Validate staples per box if provided
  const spbVal = document.getElementById('staples_per_box').value;
  if (spbVal) {
    const spb = parseInt(spbVal);
    if (isNaN(spb) || spb <= 0) {
      errors.push('Staples per box must be a positive integer');
    } else if (spb > 100000) {
      errors.push('Staples per box is unreasonably large');
    }
  }
  
  // If hot wire type, validate hot wire count
  const topWireType = document.getElementById('top_wire_type').value;
  if (topWireType === 'hot') {
    const totalWires = parseInt(document.getElementById('wire_count').value) || 1;
    const hotWires = parseInt(document.getElementById('hot_wire_count').value) || 1;
    if (hotWires < 1) {
      errors.push('Number of hot wires must be at least 1');
    }
    if (hotWires > totalWires) {
      errors.push(`Number of hot wires cannot exceed total wire count (${totalWires})`);
    }
  }
  
  // Validate post spacing if provided
  const postSpacing = document.getElementById('post_spacing').value;
  if (postSpacing) {
    const spacing = parseFloat(postSpacing);
    if (isNaN(spacing) || spacing <= 0) {
      errors.push('Post spacing must be greater than 0');
    } else if (spacing > 50) {
      errors.push('Post spacing cannot exceed 50 meters');
    }
  }
  
  // Validate wire count if provided
  const wireCount = document.getElementById('wire_count').value;
  if (wireCount) {
    const count = parseInt(wireCount);
    if (isNaN(count) || count <= 0) {
      errors.push('Wire count must be greater than 0');
    } else if (count > 20) {
      errors.push('Wire count cannot exceed 20');
    }
  }
  
  return errors;
}

async function doCalculate(evt) {
  evt.preventDefault();
  const status = document.getElementById('calc-status');
  
  // Client-side validation
  const validationErrors = validateInput();
  if (validationErrors.length > 0) {
    alert('Please fix the following errors:\n\n' + validationErrors.join('\n'));
    return;
  }
  
  status.textContent = 'Calculating…';
  try {
    // Get CSRF token from the form or meta tag
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
      // Fallback: try to get from meta tag or cookie
      csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    }
    
    // Create FormData instead of JSON to ensure CSRF works properly
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    formData.append('netting', document.getElementById('netting').value);
    formData.append('fence_length', document.getElementById('fence_length').value);
    
    const laborRate = document.getElementById('labor_rate').value;
    if (laborRate) formData.append('labor_rate', laborRate);
    
    const topWireType = document.getElementById('top_wire_type').value;
    if (topWireType) formData.append('top_wire_type', topWireType);
    if (topWireType === 'hot') {
      const hotWireCount = document.getElementById('hot_wire_count').value;
      if (hotWireCount) formData.append('hot_wire_count', hotWireCount);
    }
    
    const postSpacing = document.getElementById('post_spacing').value;
    if (postSpacing) formData.append('post_spacing', postSpacing);
    
    const wireCount = document.getElementById('wire_count').value;
    if (wireCount) formData.append('wire_count', wireCount);
    
    const spbSubmit = document.getElementById('staples_per_box').value;
    if (spbSubmit) formData.append('staples_per_box', spbSubmit);
    
    const res = await fetch('/calculate/', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (!res.ok) {
      console.error('Server response:', data);
      throw new Error(data.error || `Server error: ${res.status}`);
    }
    const b = document.getElementById('results-body');
    b.innerHTML = '';
    const rows = [
      // Materials - show posts from material_costs if available, otherwise use posts_required
      ['Wire rolls required', data.wire_rolls_required],
    ];
    
    // Add posts from material_costs (will show as "5inch posts")
    if (data.material_costs && data.material_costs.posts) {
      rows.unshift([data.material_costs.posts.material, data.material_costs.posts.quantity]);
    } else {
      rows.unshift(['5inch posts', data.posts_required]);
    }
    
    // Add stay posts if available
    if (data.material_costs && data.material_costs.stay_posts) {
      rows.push(['5 inch stay posts', data.material_costs.stay_posts.quantity]);
    }
    
    // Add triplex if available
    if (data.material_costs && data.material_costs.triplex) {
      rows.push(['Triplex', data.material_costs.triplex.quantity]);
    }
    
    // Add strainers if available
    if (data.material_costs && data.material_costs.strainers) {
      rows.push(['Strainers', data.material_costs.strainers.quantity]);
    }
    
    // Add netting if available
    if (data.material_costs && data.material_costs.netting) {
      rows.push(['Netting rolls', data.material_costs.netting.quantity]);
    }
    
    // Add staples if available
    if (data.material_costs && data.material_costs.staples) {
      rows.push([data.material_costs.staples.material, data.material_costs.staples.quantity]);
      if (data.staple_counts && data.staple_counts.total_staples !== undefined) {
        rows.push(['Staples total (ea)', data.staple_counts.total_staples]);
      }
    }
    
    
    // Add insulators if available
    if (data.insulator_counts && (data.insulator_counts.bullnose || data.insulator_counts.claw)) {
      if (data.insulator_counts.bullnose) {
        rows.push(['Insulators (bullnose)', data.insulator_counts.bullnose]);
      }
      if (data.insulator_counts.claw) {
        rows.push(['Insulators (claw)', data.insulator_counts.claw]);
      }
    }
    
    // Labor
    rows.push(['Labor hours', data.labor_hours]);
    rows.push(['Labor cost', `$${data.labor_cost.toFixed(2)}`]);
    
    // Totals
    rows.push(['Material total', `$${data.total_material_cost.toFixed(2)}`]);
    rows.push(['Total (excl. GST)', `$${data.total_cost.toFixed(2)}`]);
    rows.forEach(([k,v]) => {
      const d = document.createElement('div');
      d.textContent = `${k}: ${v}`;
      b.appendChild(d);
    });
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('pdf-link').href = `/export_pdf/${data.calculation_id}`;
    document.getElementById('xlsx-link').href = `/export_excel/${data.calculation_id}`;
  } catch (e) {
    console.error('Calculation error:', e);
    alert(`Calculation failed: ${e.message}`);
  } finally {
    status.textContent = '';
  }
}

document.getElementById('calc-form').addEventListener('submit', doCalculate);
// No visible fence type selector anymore; we use first active type for defaults
loadFenceTypes();
</script>
{% endblock %}
